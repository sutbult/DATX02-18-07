<!DOCTYPE html>
<html>

<head>
  <title>Embark Swap Application</title>
</head>

<body>

  <div style="float: left;">
  <label for="secret" class="col-lg-2 control-label">Secret</label>
    <input id="secret" style="margin-top:20px" type="text">
  <label for="digest" class="col-lg-2 control-label">Digest</label>
    <input id="digest" style="margin-top:20px" type="text">

  <label for="dest" class="col-lg-2 control-label">Destination</label>
    <input id="dest" style="margin-top:20px" type="text">

  <label for="ether" class="col-lg-2 control-label">Amount of ether to send</label>
    <input id="ether" style="margin-top:20px" type="text">
    
    <button id="contract-deploy"  style="float: middle; margin-top:15px" >
      Deploy
    </button>
  </div>
  <div style="float: left; margin-top:100px">
    <p id="status" style="float: right;"></p>
  </div>
  <div style="float: middle; margin-top:150px">
      <label for="key" class="col-lg-2 control-label">Secret</label>
        <input id="key" type="text">
      <label for="adrForHTLC" class="col-lg-2 control-label">Address to contract</label>
        <input id="adrForHTLC" type="text">
        <button id="htlc-unlock" >
          Unlock
        </button>
  </div>


  <!-- <script src="libs/solc.min.js" type="text/javascript"></script>-->
  <script src="libs/web3.min.js" type="text/javascript"></script>

  <script>
    
    window.onload = function () {
      addDeployEvent();
      addUnlockEvent();
    }






    web3FirstChain = new Web3(new Web3.providers.HttpProvider('http://localhost:7545'));
    web3SecondChain = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
    console.log(web3FirstChain.isConnected());
    console.log(web3SecondChain.isConnected());
    var abi;
    var bytecode;
    var gContract;
    //This is only needed when you try to claim, so only needed on web3SecondChain
    //web3FirstChain.eth.defaultAccount = web3FirstChain.eth.coinbase;
    var accounts = []    
    web3FirstChain.eth.getAccounts((err,acc) => {
        console.log(acc);
        accounts.push(acc);
    });

    //this function gets called by addDeployEvent() when you press the deploy btn
    function prepareAndDeploy(){
      //bytecode = '0x'+compiledContract.contracts[":HTLC"].bytecode; //hardcoded specifying htl-contract
      //abi = JSON.parse(compiledContract.contracts[":HTLC"].interface);
      
      var p_digest;
      //Will differ if you placed or accepted bid
      if(!document.getElementById('secret').value){
        p_digest = document.getElementById('digest').value;
      }else{
        p_digest = web3FirstChain.sha3(document.getElementById('secret').value);
      }

      //var p_digest = web3FirstChain.sha3(document.getElementById('secret').value);
      var p_dest = document.getElementById('dest').value;
      var ether = web3FirstChain.toWei(document.getElementById('ether').value, "ether");//web3FirstChain.toWei(10,"ether");

      var contract = web3FirstChain.eth.contract(abi);
      let gasEstimate =  4712386;//web3FirstChain.eth.estimateGas({data: bytecode});
      var contractInstance = contract.new(p_digest,p_dest, {data: bytecode,gas: gasEstimate,from: web3FirstChain.eth.coinbase, value: ether});
      gContract = contractInstance;
      waitBlock(contractInstance);
    }

    function addDeployEvent(){
      const deployBtn = document.getElementById('contract-deploy');
      deployBtn.addEventListener('click', prepareAndDeploy);
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // wait until any miner has included the transaction
    // in a block to get the address of the contract
    async function waitBlock(contract) {
      while (true) {
        let receipt = web3FirstChain.eth.getTransactionReceipt(contract.transactionHash);
        if (receipt && receipt.contractAddress) {
          status("Contract deployed at " + receipt.contractAddress);
          addEvent();
          break;
        }
        status("Waiting for miners");
        console.log("Waiting for a mined block to include your contract... currently in block " + web3FirstChain.eth.blockNumber);
        await sleep(4000);
      }
    }
    
    function unlock(){
      
      web3SecondChain.eth.defaultAccount = web3SecondChain.eth.coinbase;
      let contract = web3SecondChain.eth.contract(abi);
      let contractInstance = contract.at(document.getElementById('adrForHTLC').value);
      console.log(contractInstance);
      let _hash = document.getElementById('key').value;
      
      contractInstance.claim(_hash);
    }

    function addEvent(){
      console.log("Here");
      var claimEvent = gContract.Claim();
      
      claimEvent.watch(function(error,result) {
        //TODO: add automated unlock here!
        if(!error){
          console.log("The secret is " + result.args._hash.toString());
          //This is hardcoded for my second account 
          console.log(web3FirstChain.fromWei(web3FirstChain.eth.getBalance('0xd513156a649ee0112a721ea9b4ea92ee7beb5ffd')).c["0"]);
        } else {
          console.log(error);
        }
      });
    }

    function addUnlockEvent(){
      const unlockBtn = document.getElementById('htlc-unlock');
      unlockBtn.addEventListener('click', unlock);
    }
    
    function status(txt) {
      document.getElementById('status').innerHTML = txt
    }
  </script>

</body>

</html>